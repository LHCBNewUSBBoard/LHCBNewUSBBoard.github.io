<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Operation Manual - My Docs</title>
  

  <link rel="shortcut icon" href="../img/favicon.ico">

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">

  
  <script>
    // Current page data
    var mkdocs_page_name = "Operation Manual";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script>
  <script src="../js/theme.js"></script> 

  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> My Docs</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        <ul class="current">
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="..">USBBoard for SiPM readout</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../System_Structure/">System Structure</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../Development_Process/">Development Process</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 current">
        <a class="current" href="./">Operation Manual</a>
        
            <ul>
            
                <li class="toctree-l3"><a href="#-hardware-">-------------- Hardware ------------------</a></li>
                
                    <li><a class="toctree-l4" href="#11-power-supply">1.1 Power Supply</a></li>
                
                    <li><a class="toctree-l4" href="#12-important-signals">1.2 Important signals</a></li>
                
            
                <li class="toctree-l3"><a href="#-firmware-">-------------- Firmware ------------------</a></li>
                
                    <li><a class="toctree-l4" href="#21-external-vs-internal-trigger">2.1 External vs Internal Trigger</a></li>
                
                    <li><a class="toctree-l4" href="#22-description-of-global-registers">2.2 Description of Global Registers</a></li>
                
            
                <li class="toctree-l3"><a href="#-software-">---------------- software --------------------------</a></li>
                
                    <li><a class="toctree-l4" href="#31-cfgfile">3.1 cfgFile</a></li>
                
                    <li><a class="toctree-l4" href="#32-utils">3.2 Utils</a></li>
                
                    <li><a class="toctree-l4" href="#33-data-acquisition-procedure">3.3 Data Acquisition Procedure</a></li>
                
            
            </ul>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../BugIssues_FreqAsks/">Bug Issues & Freq Asks</a>
        
    </li>
<li>
          
            <li>
    <li class="toctree-l1 ">
        <a class="" href="../about/">About</a>
        
    </li>
<li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">My Docs</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
    
    <li>Operation Manual</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="-hardware-">-------------- Hardware ------------------</h1>
<h2 id="11-power-supply">1.1 Power Supply</h2>
<p>The power supply of the NewUSBBoard is divided into:</p>
<ul>
<li>Digital power for the acquisition FPGA and USB interface +D3.3V (1A). This power supply is isolated from all other power supplies via magneto couplers.  </li>
<li>Analog power is different for different front-end board. Jumpers are used to select the exact type of FE board:  <blockquote>
<ul>
<li>W1+W4 , 1&amp;2 in APWR_SET are connected -- VA64  </li>
<li>W2+W5 , 1&amp;2 in APWR_SET are connected -- VA32  </li>
<li>W3+W6 , 3&amp;4 in APWR_SET are connected -- SPIROC
<img alt="ADB Power Supply" src="../pics/ADB_power_supply.png" title="ADB Power Supply" /></li>
</ul>
</blockquote>
</li>
</ul>
<h2 id="12-important-signals">1.2 Important signals</h2>
<h3 id="external-trigger-busy-piggyback-board">External Trigger &amp; Busy (piggyback board)</h3>
<p>The middle pin of the jumpers "NIM_TRIG" and "NIM_BUSY" in piggyback board  are the TTL signals for TRIG_OUT and BUSY_OUT.</p>
<h3 id="external-led-pulse-piggyback-board">External LED Pulse (piggyback board)</h3>
<p>The middle pin of the jumper "ADB_TP" in piggyback board is the TTL Pulse for laser driver.</p>
<h3 id="analog-signal-from-front-end-board-newusbboard">Analog signal from front-end board (NewUSBBoard)</h3>
<p>The analog signal from front-end board is directly measured by ADC, and it can be also measured from the two pins of c59 on NewUSBBoard by oscilloscope. When the Spiroc works in normal mode, the analog signal is the peak value. And when the Spiroc works in trace mode, and without self-trigger signal, the analog signal is the actual waveforms after shaping.</p>
<h3 id="hold_b-signal-spiroc-front-end-board">Hold_B signal (Spiroc front-end board)</h3>
<p>TP10</p>
<h1 id="-firmware-">-------------- Firmware ------------------</h1>
<h2 id="21-external-vs-internal-trigger">2.1 External vs Internal Trigger</h2>
<p>The data acquisition is driven by a trigger signal which can be used and generated in two different ways.</p>
<h3 id="internal-trigger">Internal Trigger</h3>
<p>A trigger is generated by the NewUSBBoard itself in this mode. It is usually used in the calibration.
The trigger is generated periodically. The variable period is controlled by <code>selfTrigPeriod</code>.<br />
Up on the generation of a internal trigger, a light injection pulse is send to the laser driver to inject light into the SiPM detectors and the readout sequence is ready to start. The width of the trigger pulse is changeable, determined by <code>LI_phase_adj</code>.<br />
To get valid data, adjust the <code>selfTrigLeadPeriod</code>, <code>holdDelayTime</code> and <code>fifoWriteDelay</code> and make sure the equation shown in the Figure 2.3.1 is satisfied.</p>
<p><img alt="Self Trigger Structure" src="../pics/self_trigger_structure.png" title="Self Trigger Structure" />
<center>Figure 2.3.1</center></p>
<ul>
<li>T1 is summed up to 120 ns composed of <code>???</code> ns NIM to TTL conversion, 6 ns digial isolators, 1.5ns TTL to LVDS conversion and so on...</li>
<li>T2 = hold_delay_time * 25 ns</li>
<li>T3 = self_trig_lead_time * 25 ns</li>
<li>T4 unknown</li>
<li>T5 peaking time of readout chip - for SpirocA 25 ~ 175ns</li>
</ul>
<h3 id="external-trigger">External Trigger</h3>
<p>Typically in a test beam setup an external trigger is generated by some trigger logic used to generate the coincidence with traversing particles. This trigger is processed ”asynchronous” to set the hold signal of the attached Front End modules via Up-Link control signals. The delay between trigger and hold signal is fixed(T1 in Figure 2.3.1), and it is strongly required to be as low as possible, since the total trigger delay between crossing particle and hold signal must be equal to the peaking time of readout chip in external trigger mode.</p>
<p>Up on a trigger, the hold signal control on the Up-Link connector for all links is set to low (<code>???ns</code> delay) and the sampling sequence is started. During the sampling the Busy out signal is set high and new triggers during this time need to be gated in the trigger generation. Synchronization in the external trigger mode can be reached by sending at the beginning of the data acquisition a software Reset daq or a external Reset daq which resets all FIFOs and the readout finite state machine. A trigger counter is attached in the data which allows to collect synchronous data over several USB boards.</p>
<h2 id="22-description-of-global-registers">2.2 Description of Global Registers</h2>
<p>A set of control and monitor registers are provided. Below a description of its functionality is given. All the registers are accessed in the high speed mode. For the access to the registers, two tools in the scifiusbboard/Builds/ are used:</p>
<blockquote>
<p><code>./readoutDebugtool -r reg_address</code><br />
<code>./readoutDebugtool -w reg_address reg_value</code></p>
</blockquote>
<h4 id="reg0-addr0x0000-fromt-end-type-trigger-select-register">Reg0, addr=0x0000, Fromt End Type &amp; Trigger Select Register</h4>
<table>
<thead>
<tr>
<th align="center">Bits</th>
<th align="center">Access</th>
<th align="center">Signal Name</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">2..0</td>
<td align="center">R/W</td>
<td align="center">FE_Type</td>
<td align="left">Select the Front-End card</td>
</tr>
<tr>
<td align="center">3</td>
<td align="center">R/W</td>
<td align="center">self_trigger_enable</td>
<td align="left">0: Enable external trigger <br>1: Enable internal trigger</td>
</tr>
<tr>
<td align="center">4</td>
<td align="center">R/W</td>
<td align="center">led_enable</td>
<td align="left">0: Disable the laser driver <br>1: Enable the laser driver</td>
</tr>
<tr>
<td align="center">15..5</td>
<td align="center">R/W</td>
<td align="center">Reserved</td>
<td align="left"></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>Signal Name</th>
<th align="center">Value</th>
<th>Front-End card</th>
<th align="center">number of sampers per Up-link</th>
</tr>
</thead>
<tbody>
<tr>
<td>FE_Type</td>
<td align="center">0b000</td>
<td>VA32</td>
<td align="center">128</td>
</tr>
<tr>
<td>FE_Type</td>
<td align="center">0b001</td>
<td>SPIROC_EPFL</td>
<td align="center">36</td>
</tr>
<tr>
<td>FE_Type</td>
<td align="center">0b010</td>
<td>SPIROC_Aachen</td>
<td align="center">128</td>
</tr>
<tr>
<td>FE_Type</td>
<td align="center">0b011</td>
<td>AMS_K_ladder</td>
<td align="center">6x64</td>
</tr>
<tr>
<td>FE_Type</td>
<td align="center">0b100</td>
<td>AMS_S_ladder</td>
<td align="center">5x64</td>
</tr>
<tr>
<td>FE_Type</td>
<td align="center">0b101</td>
<td>HPE_VA256</td>
<td align="center">256</td>
</tr>
<tr>
<td>FE_Type</td>
<td align="center">0b110</td>
<td>SPIROC_A</td>
<td align="center">64</td>
</tr>
<tr>
<td>FE_Type</td>
<td align="center">0b111</td>
<td>VATA64_EPFL</td>
<td align="center">64</td>
</tr>
</tbody>
</table>
<h4 id="reg1-addr0x0001-reset-daq-register">Reg1, addr=0x0001, Reset DAQ Register</h4>
<table>
<thead>
<tr>
<th align="center">Bits</th>
<th align="center">Access</th>
<th align="center">Signal Name</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">0</td>
<td align="center">R/W</td>
<td align="center">reset_daq_reg</td>
<td align="left">Reset the DAQ part of the board, including FIFOs and FSM.</td>
</tr>
<tr>
<td align="center">15..1</td>
<td align="center">R/W</td>
<td align="center">Reserved</td>
<td align="left"></td>
</tr>
</tbody>
</table>
<h4 id="reg2-addr0x0002-control-register">Reg2, addr=0x0002, Control Register</h4>
<table>
<thead>
<tr>
<th align="center">Bits</th>
<th align="center">Access</th>
<th align="center">Signal Name</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">0</td>
<td align="center">R/W</td>
<td align="center">FE_CLock_Mode</td>
<td align="left"><code>Set Front-End Board Clock Mode??</code></td>
</tr>
<tr>
<td align="center">1</td>
<td align="center">R/W</td>
<td align="center">manual_set_busy</td>
<td align="left">’0’=normal operation ,’1’=set the busy<br>can be used to test the busy connection or gate the trigger during setup</td>
</tr>
<tr>
<td align="center">15..2</td>
<td align="center">R/W</td>
<td align="center">Reserved</td>
<td align="left"></td>
</tr>
</tbody>
</table>
<h4 id="reg3addr0x0003-fifo-monitor-register">Reg3,addr=0x0003, Fifo monitor register</h4>
<table>
<thead>
<tr>
<th align="center">Bits</th>
<th align="center">Access</th>
<th align="center">Signal Name</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">0</td>
<td align="center">R</td>
<td align="center">fifo_usedw(16)</td>
<td align="left">17th bit of Used word of the input FIFOs, it is the same for all FIFOs</td>
</tr>
<tr>
<td align="center">12..1</td>
<td align="center">R</td>
<td align="center">Reserved</td>
<td align="left"></td>
</tr>
<tr>
<td align="center">13</td>
<td align="center">R</td>
<td align="center">fifo_almost_full</td>
<td align="left">Indicates that the FIFO can not receive any more events</td>
</tr>
<tr>
<td align="center">14</td>
<td align="center">R</td>
<td align="center">fifo_underflow</td>
<td align="left">fifo underflow</td>
</tr>
<tr>
<td align="center">15</td>
<td align="center">R</td>
<td align="center">fifo_overflow</td>
<td align="left">fifo overflow</td>
</tr>
</tbody>
</table>
<h4 id="reg4addr0x0004-fifo-monitor-register">Reg4,addr=0x0004, Fifo monitor register</h4>
<table>
<thead>
<tr>
<th align="center">Bits</th>
<th align="center">Access</th>
<th align="center">Signal Name</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">15..0</td>
<td align="center">R</td>
<td align="center">fifo_usedw(15 to 0)</td>
<td align="left">0~15 bit of Used word of the input FIFOs, it is the same for all FIFOs</td>
</tr>
</tbody>
</table>
<h4 id="reg5addr0x0005-event-id-monitor-register">Reg5,addr=0x0005, Event ID monitor register</h4>
<table>
<thead>
<tr>
<th align="center">Bits</th>
<th align="center">Access</th>
<th align="left">Signal Name</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">15..0</td>
<td align="center">R</td>
<td align="left">event_ID</td>
<td align="left">The Event ID counter at the current time.<br>Note that this counter can increase very fast.</td>
</tr>
</tbody>
</table>
<h4 id="reg6addr0x0006-version-monitor-register">Reg6,addr=0x0006, Version monitor register</h4>
<table>
<thead>
<tr>
<th align="center">Bits</th>
<th align="center">Access</th>
<th align="center">Signal Name</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">0..7</td>
<td align="center">R</td>
<td align="center">FW_VERSION_DEFAULT</td>
<td align="left"><code>Not Used???</code></td>
</tr>
<tr>
<td align="center">8..14</td>
<td align="center">R</td>
<td align="center">Reserved</td>
<td align="left"></td>
</tr>
<tr>
<td align="center">15</td>
<td align="center">R</td>
<td align="center">DATA_TYPE</td>
<td align="left"><code>Not Used???</code></td>
</tr>
</tbody>
</table>
<h4 id="reg7addr0x0007-fifo-write-delay-register">Reg7,addr=0x0007, Fifo Write Delay register</h4>
<table>
<thead>
<tr>
<th align="center">Bits</th>
<th align="center">Access</th>
<th align="center">Signal Name</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">0..15</td>
<td align="center">R/W</td>
<td align="center">fifoWriteDelay</td>
<td align="left"></td>
</tr>
</tbody>
</table>
<h4 id="reg8addr0x0008-delay-after-readout-register">Reg8,addr=0x0008, Delay After Readout register</h4>
<table>
<thead>
<tr>
<th align="center">Bits</th>
<th align="center">Access</th>
<th align="center">Signal Name</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">0..15</td>
<td align="center">R/W</td>
<td align="center">delay_after_readout</td>
<td align="left"></td>
</tr>
</tbody>
</table>
<h4 id="reg9addr0x0009-self-trigger-lead-time-register">Reg9,addr=0x0009, Self Trigger Lead Time Register</h4>
<table>
<thead>
<tr>
<th align="center">Bits</th>
<th align="center">Access</th>
<th align="center">Signal Name</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">0..15</td>
<td align="center">R/W</td>
<td align="center">SELF_trig_lead_time(31 to 16)</td>
<td align="left"></td>
</tr>
</tbody>
</table>
<h4 id="reg10addr0x000a-self-trigger-lead-time-register">Reg10,addr=0x000A, Self Trigger Lead Time Register</h4>
<table>
<thead>
<tr>
<th align="center">Bits</th>
<th align="center">Access</th>
<th align="center">Signal Name</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">0..15</td>
<td align="center">R/W</td>
<td align="center">SELF_trig_lead_time(15 to 0)</td>
<td align="left"></td>
</tr>
</tbody>
</table>
<h4 id="reg11reg18-addr0x000b-0x0012-8-data-header-registers">Reg11~Reg18, addr=0x000B ~ 0X0012, 8 data header registers</h4>
<table>
<thead>
<tr>
<th align="center">Bits</th>
<th align="center">Access</th>
<th align="center">Signal Name</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">0..15</td>
<td align="center">R/W</td>
<td align="center">data_header</td>
<td align="left"><code>start from data_header(1)??</code><br> Each Up-Link has its individual header word which is stored in one of the 8 registers</td>
</tr>
</tbody>
</table>
<h4 id="reg19addr0x0013-self-trigger-period-register">Reg19,addr=0x0013, Self Trigger Period register</h4>
<table>
<thead>
<tr>
<th align="center">Bits</th>
<th align="center">Access</th>
<th align="center">Signal Name</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">0..15</td>
<td align="center">R/W</td>
<td align="center">SELF_TRIG_PERIOD(31 to 16)</td>
<td align="left">Self Trigger Period = Register Value * 25 ns</td>
</tr>
</tbody>
</table>
<h4 id="reg20addr0x0014-self-trigger-period-register">Reg20,addr=0x0014, Self Trigger Period register</h4>
<table>
<thead>
<tr>
<th align="center">Bits</th>
<th align="center">Access</th>
<th align="center">Signal Name</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">0..15</td>
<td align="center">R/W</td>
<td align="center">SELF_TRIG_PERIOD(15 to 0)</td>
<td align="left">Self Trigger Period = Register Value * 25 ns</td>
</tr>
</tbody>
</table>
<h4 id="reg21addr0x0015-qspi-register">Reg21,addr=0x0015, QSPI register</h4>
<table>
<thead>
<tr>
<th align="center">Bits</th>
<th align="center">Access</th>
<th align="center">Signal Name</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">0..9</td>
<td align="center">R/W</td>
<td align="center">QSPI_start_addr</td>
<td align="left">QSPI start address</td>
</tr>
<tr>
<td align="center">10..13</td>
<td align="center">R/W</td>
<td align="center">Reserved</td>
<td align="left"></td>
</tr>
<tr>
<td align="center">14</td>
<td align="center">R/W</td>
<td align="center">QSPI_repeat_enable</td>
<td align="left">QSPI repeat enable</td>
</tr>
<tr>
<td align="center">15</td>
<td align="center">R/W</td>
<td align="center">QSPI_busy</td>
<td align="left">QSPI busy</td>
</tr>
</tbody>
</table>
<h4 id="reg22addr0x0016-qspi-register">Reg22,addr=0x0016, QSPI register</h4>
<table>
<thead>
<tr>
<th align="center">Bits</th>
<th align="center">Access</th>
<th align="center">Signal Name</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">0..9</td>
<td align="center">R/W</td>
<td align="center">QSPI_end_addr</td>
<td align="left">QSPI end address</td>
</tr>
<tr>
<td align="center">10..15</td>
<td align="center">R/W</td>
<td align="center">Reserved</td>
<td align="left"></td>
</tr>
</tbody>
</table>
<h4 id="reg23addr0x0017-qspi-register">Reg23,addr=0x0017, QSPI register</h4>
<table>
<thead>
<tr>
<th align="center">Bits</th>
<th align="center">Access</th>
<th align="center">Signal Name</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">0..11</td>
<td align="center">R/W</td>
<td align="center">QMR(11 to 0)</td>
<td align="left"><code>QMR???</code></td>
</tr>
<tr>
<td align="center">12</td>
<td align="center">R/W</td>
<td align="center">Reserved</td>
<td align="left"></td>
</tr>
<tr>
<td align="center">12..15</td>
<td align="center">R/W</td>
<td align="center">QMR(15 to 13)</td>
<td align="left"><code>QMR???</code></td>
</tr>
</tbody>
</table>
<h4 id="reg24addr0x0018-qspi-register">Reg24,addr=0x0018, QSPI register</h4>
<table>
<thead>
<tr>
<th align="center">Bits</th>
<th align="center">Access</th>
<th align="center">Signal Name</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">0..15</td>
<td align="center">R/W</td>
<td align="center">QDLYR</td>
<td align="left"><code>QDLYR???</code></td>
</tr>
</tbody>
</table>
<h4 id="reg25addr0x0019-bias-voltage-1-spi-control-register">Reg25,addr=0x0019, Bias Voltage 1 SPI control register</h4>
<table>
<thead>
<tr>
<th align="center">Bits</th>
<th align="center">Access</th>
<th align="center">Signal Name</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">0..15</td>
<td align="center">R/W</td>
<td align="center">VB1_cTx</td>
<td align="left">SPI control register for Bias Voltage 1</td>
</tr>
</tbody>
</table>
<h4 id="reg26addr0x001a-bias-voltage-2-spi-control-register">Reg26,addr=0x001A, Bias Voltage 2 SPI control register</h4>
<table>
<thead>
<tr>
<th align="center">Bits</th>
<th align="center">Access</th>
<th align="center">Signal Name</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">0..15</td>
<td align="center">R/W</td>
<td align="center">VB2_cTx</td>
<td align="left">SPI control register for Bias Voltage 2</td>
</tr>
</tbody>
</table>
<h4 id="reg27addr0x001b-hold-delay-time-register">Reg27,addr=0x001B, Hold delay time register</h4>
<table>
<thead>
<tr>
<th align="center">Bits</th>
<th align="center">Access</th>
<th align="center">Signal Name</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">0..15</td>
<td align="center">R/W</td>
<td align="center">hold_delay_time</td>
<td align="left">hold delay time</td>
</tr>
</tbody>
</table>
<h4 id="reg28addr0x001c-hold-type-register">Reg28,addr=0x001C, Hold type register</h4>
<table>
<thead>
<tr>
<th align="center">Bits</th>
<th align="center">Access</th>
<th align="center">Signal Name</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">0..7</td>
<td align="center">R/W</td>
<td align="center">hold_type</td>
<td align="left">hold type</td>
</tr>
<tr>
<td align="center">7..15</td>
<td align="center">R/W</td>
<td align="center">Reserved</td>
<td align="left"></td>
</tr>
</tbody>
</table>
<h4 id="reg29addr0x001d-qspi-register">Reg29,addr=0x001D, QSPI register</h4>
<table>
<thead>
<tr>
<th align="center">Bits</th>
<th align="center">Access</th>
<th align="center">Signal Name</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">0..15</td>
<td align="center">R/W</td>
<td align="center">QSPI_PERIOD(31 to 16)</td>
<td align="left">QSPI Period</td>
</tr>
</tbody>
</table>
<h4 id="reg30addr0x001e-qspi-register">Reg30,addr=0x001E, QSPI register</h4>
<table>
<thead>
<tr>
<th align="center">Bits</th>
<th align="center">Access</th>
<th align="center">Signal Name</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">0..15</td>
<td align="center">R/W</td>
<td align="center">QSPI_PERIOD(15 to 0)</td>
<td align="left">QSPI Period</td>
</tr>
</tbody>
</table>
<h4 id="reg31addr0x001f-light-injection-i2c-register">Reg31,addr=0x001F, Light Injection I2C register</h4>
<table>
<thead>
<tr>
<th align="center">Bits</th>
<th align="center">Access</th>
<th align="center">Signal Name</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">0</td>
<td align="center">R/W</td>
<td align="center">LI_i2c_dis</td>
<td align="left">0:Light Injection Module Enable<br>1:Light Injection Module Enable</td>
</tr>
<tr>
<td align="center">7...1</td>
<td align="center">R/W</td>
<td align="center">LI_i2c_slave_wr_adr</td>
<td align="left">1~7 bit of Light Injection Module I2C slave write address</td>
</tr>
<tr>
<td align="center">8...15</td>
<td align="center">R/W</td>
<td align="center">LI_i2c_slave_rd_adr</td>
<td align="left">Light Injection Module I2C slave read address = write address&amp;'0'</td>
</tr>
</tbody>
</table>
<h4 id="reg32addr0x0020-light-injection-i2c-register">Reg32,addr=0x0020, Light Injection I2C register</h4>
<table>
<thead>
<tr>
<th align="center">Bits</th>
<th align="center">Access</th>
<th align="center">Signal Name</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">0..13</td>
<td align="center">R/W</td>
<td align="center">Reserved</td>
<td align="left"></td>
</tr>
<tr>
<td align="center">14</td>
<td align="center">R/W</td>
<td align="center">LI_i2c_wr_done</td>
<td align="left">1: i2c write operation has finished.</td>
</tr>
<tr>
<td align="center">15</td>
<td align="center">R/W</td>
<td align="center">LI_i2c_err</td>
<td align="left">1: error happens during i2c operation</td>
</tr>
</tbody>
</table>
<h4 id="reg33addr0x0021-light-injection-i2c-register">Reg33,addr=0x0021, Light Injection I2C register</h4>
<table>
<thead>
<tr>
<th align="center">Bits</th>
<th align="center">Access</th>
<th align="center">Signal Name</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">0..7</td>
<td align="center">R/W</td>
<td align="center">LI_i2c_reg_rd_dat</td>
<td align="left">The value read by i2c operation</td>
</tr>
<tr>
<td align="center">8..13</td>
<td align="center">R/W</td>
<td align="center">Reserved</td>
<td align="left"></td>
</tr>
<tr>
<td align="center">14</td>
<td align="center">R/W</td>
<td align="center">LI_i2c_err</td>
<td align="left">1: error happens during i2c operation</td>
</tr>
<tr>
<td align="center">15</td>
<td align="center">R/W</td>
<td align="center">LI_i2c_rd_done</td>
<td align="left">1: i2c read operation has finished.</td>
</tr>
</tbody>
</table>
<h4 id="reg34addr0x0022-light-injection-pulse-width-register">Reg34,addr=0x0022, Light Injection Pulse Width register</h4>
<table>
<thead>
<tr>
<th align="center">Bits</th>
<th align="center">Access</th>
<th align="center">Signal Name</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">0..7</td>
<td align="center">R/W</td>
<td align="center">LI_phase_adj</td>
<td align="left">Adjust the pulse width for the light injection module, need calibration</td>
</tr>
<tr>
<td align="center">8..13</td>
<td align="center">R/W</td>
<td align="center">Reserved</td>
<td align="left"></td>
</tr>
</tbody>
</table>
<h4 id="qspi-block-address">QSPI block address</h4>
<table>
<thead>
<tr>
<th align="center">Start Address</th>
<th align="center">End Address</th>
<th align="center">Signal Name</th>
<th align="left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">0x0400</td>
<td align="center">0x0800</td>
<td align="center">qspi_tx_rdback</td>
<td align="left"></td>
</tr>
<tr>
<td align="center">0x0800</td>
<td align="center">0x0C00</td>
<td align="center">qspi_cmd_rdback</td>
<td align="left"></td>
</tr>
<tr>
<td align="center">0x0C00</td>
<td align="center">0x1000</td>
<td align="center">qspi_rx_rdback</td>
<td align="left"></td>
</tr>
</tbody>
</table>
<h1 id="-software-">---------------- software --------------------------</h1>
<h2 id="31-cfgfile">3.1 cfgFile</h2>
<p>The configure file of NewUSBBoard is the cfgFile/board+ID.cfg. It sets the values of many variables. These variables and their meanings are listed below:  </p>
<table>
<thead>
<tr>
<th align="center">variable name</th>
<th align="center">bits</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">pathToUsbBoardFirmware</td>
<td align="center"></td>
<td>path to NewUsbBoard Firmware(*.rbf)</td>
</tr>
<tr>
<td align="center">usbBoardID</td>
<td align="center"></td>
<td>Board ID, comes from the QuickUSB ID. <br>See function boardID( ) in readout/UsbBoard.cpp.</td>
</tr>
<tr>
<td align="center">withUplinkAdapter</td>
<td align="center">1</td>
<td>UsbBoard with or without a V1-&gt;V3 uplink adapter, with = 1, without = 0. <br>Not used in NewUsbBoard.</td>
</tr>
<tr>
<td align="center">eventsPerAccess</td>
<td align="center">16</td>
<td>Number of events read from USB board per USB block transfer (restricted by FIFO buffer size).</td>
</tr>
<tr>
<td align="center">modeSel</td>
<td align="center">3</td>
<td>Select mode to define the number of samples readout from the front end card, the same variable with FE_Type in firmware.<br>0=VA32<br>1=SPIROC_EPFL<br>2=SPIROC_Aachen<br>3=AMS_K_ladder<br>4=AMS_S_ladder<br>5=HPE_VA256<br>6=SPIROC_A<br>7=VATA64_EPFL</td>
</tr>
<tr>
<td align="center">selfTrigEnable</td>
<td align="center">1</td>
<td>1=self trigger mode<br>0= external trigger mode</td>
</tr>
<tr>
<td align="center">selfTrigPeriod</td>
<td align="center">32</td>
<td>number of 25ns clock cycles for the self trigger period.</td>
</tr>
<tr>
<td align="center">selfTrigLeadPeriod</td>
<td align="center">32</td>
<td>number of 25ns clock cycles for the delay of trigger pulse to laser driver, which is designed for led calibration mode.</td>
</tr>
<tr>
<td align="center">ledInjectionModeOn</td>
<td align="center">1</td>
<td>0=Disable the laser driver<br>1=enable the laser driver</td>
</tr>
<tr>
<td align="center">holdDelayTime</td>
<td align="center">16</td>
<td>number of 25ns clock cycles delay between trigger and hold signal.</td>
</tr>
<tr>
<td align="center">holdType</td>
<td align="center">1</td>
<td>Sel on each uplink 1..8:<br>fast hold time = 0 (no delay)<br>slow hold time = 1 (insert holdDelayTime)</td>
</tr>
<tr>
<td align="center">uplinkID</td>
<td align="center">8</td>
<td>Make uplinkID=boardID*10 + uplink_order for better understanding.</td>
</tr>
<tr>
<td align="center">uplinkUse</td>
<td align="center">string</td>
<td>Just a comment in software of the use for each uplink 1..8 void.(Don't use spaces)</td>
</tr>
<tr>
<td align="center">calDelay</td>
<td align="center"></td>
<td><strong>not used now</strong></td>
</tr>
<tr>
<td align="center">delayAfterReadout</td>
<td align="center">16</td>
<td>Number of 25ns clock cycles to wait after each event readout from the front end.</td>
</tr>
<tr>
<td align="center">clkSelect</td>
<td align="center">1</td>
<td>0 = single clock sequence double<br>1 = clock sequence readout</td>
</tr>
<tr>
<td align="center">fifoWriteDelay</td>
<td align="center">16</td>
<td>Select a 25ns clock cycle delay for the data valid at the input of the Fifos (delay to adjust with he sampling time of the ADC).</td>
</tr>
<tr>
<td align="center">busyOutputSwitch</td>
<td align="center">1</td>
<td>Set this bit to 1 to impose busy output 1, its to fake a busy state.</td>
</tr>
<tr>
<td align="center">biasSelect</td>
<td align="center">8</td>
<td>for bias Voltage, <strong>not used now</strong></td>
</tr>
<tr>
<td align="center">biasVoltage</td>
<td align="center">float</td>
<td>for bias Voltage, <strong>not used now</strong></td>
</tr>
<tr>
<td align="center">frontEndBoardType</td>
<td align="center">3</td>
<td>choose the right frontEnd board type and use the corresponding configure file to configure it.<br><strong>not used now</strong>.<br>Use <code>SpirocSlowControl</code> to configure the SpirocA board</td>
</tr>
<tr>
<td align="center">executeFrontEndBoardConfiguration</td>
<td align="center">1</td>
<td>execute Configuration for each uplink: 0 do not configure, 1 configure</td>
</tr>
<tr>
<td align="center">adjustDACMode</td>
<td align="center">1</td>
<td><strong>not used now</strong></td>
</tr>
</tbody>
</table>
<h2 id="32-utils">3.2 Utils</h2>
<p>The bin files are under <em>./Builds</em>, while the souce code are under <em>./utils</em>.</p>
<h3 id="readout-test-system">Readout Test System</h3>
<ul>
<li>
<p><code>readoutDebugtool</code> -- read and write the global registers in the firmware  </p>
<blockquote>
<p><code>readoutDebugtool -r reg_address</code><br />
<code>readoutDebugtool -w reg_address reg_value</code></p>
</blockquote>
</li>
<li>
<p><code>adcView</code> -- Start the readout sequence. Readout and display the resultes in real time.</p>
</li>
<li><code>readoutTest</code> -- Start the readout sequence and readout pre-defined number of events before stop.</li>
<li><code>lis_piggyback</code> -- Configure the laser driver holding on the piggyback board.</li>
<li><code>SpirocSlowControl</code> -- Configure the SPIROC board.</li>
</ul>
<h3 id="data-analysis-system">Data Analysis System</h3>
<ul>
<li><code>noiseAnalysis</code></li>
<li><code>rawAnalysis</code></li>
</ul>
<h2 id="33-data-acquisition-procedure">3.3 Data Acquisition Procedure</h2>
<h3 id="331-set-proper-parameters-only-do-it-once">3.3.1 Set Proper Parameters (only do it once)</h3>
<p>The following parameters should be considered to get the single proton signal:  </p>
<ul>
<li>self_trig_lead_time (selfTrigLeadPeriod)</li>
<li>hold_delay_time (holdDelayTime)</li>
</ul>
<p>HOW TO SET PROPER PARAMETERS:  </p>
<ol>
<li>Measure the delay between self-trigger and hold_B (TP10 in SpirocA front-end board)  </li>
<li>Measure the delay between self-trigger and actual analog output of front-end board (two pins of c59, SpirocA works in trace mode)  </li>
<li>adjust the holdDelayTime and selfTrigPeriod to make these two signals in alignment.  </li>
</ol>
<h3 id="332-configure-the-spiroca">3.3.2 Configure the SpirocA</h3>
<p>Use SpirocSlowControl to configure the SpirocA:  </p>
<ol>
<li>Use Hold/hold_B rather than Trig.</li>
<li>Set the DAC to 4.5v. (The actual BIAS Voltage of SiPM is "BIAS - 4.5") (only do itonce)</li>
<li>Set the proper board ID and uplink.</li>
</ol>
<p>for the first time:<br />
<code>./spirocSlowControl -p ../cfgFiles/ -b board_ID -u uplink_order -d 0_0_0_0_0_0_0_0 -i 1</code>
for the rest time:<br />
<code>./spirocSlowControl -p ../cfgFiles/ -b board_ID -u uplink_order -i 1</code>  </p>
<ul>
<li>-p : the directory of configure file</li>
<li>-b : board ID</li>
<li>-u : uplink order, starts from 0</li>
<li>-i : Select the trigger, 1:Trigger from hold_B;0:Trigger from Trig</li>
</ul>
<h3 id="333-configure-the-laser-driver">3.3.3 Configure the laser driver</h3>
<p>Use lis_piggyback to configure the laser driver</p>
<table>
<thead>
<tr>
<th align="center">Diode</th>
<th align="center">Address</th>
<th align="center">Amplitude</th>
<th align="left">Bias current</th>
<th align="left">Pre Amplitude</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center">4</td>
<td align="center">0x7e</td>
<td align="center">0x30=48</td>
<td align="left">0x02=2</td>
<td align="left">0xff=255</td>
</tr>
</tbody>
</table>
<h3 id="334-acquire-the-pedestal">3.3.4 Acquire the Pedestal</h3>
<p>Use adcView to acquire data.<br />
<code>./adcView ../cfgFiles</code></p>
<h3 id="334-set-the-bias-high-voltage">3.3.4 Set the BIAS (high Voltage)</h3>
<p>Voltage is 62V and Current Limit is 100uA.<br />
Typically the dark current is around 1uA when the LED doesn't work.</p>
<h3 id="335-preliminary-data-acquisition">3.3.5 Preliminary data acquisition</h3>
<p>Use adcView to acquire data.</p>
<p><img alt="EPFL SiPM Test Results" src="../pics/EPFL_SiPM_Test_Results.png" title="EPFL SiPM Test Results" /></p>
<h3 id="335-record-data-for-further-analysis">3.3.5 Record Data for Further Analysis</h3>
<p>Use hdReadoutTest or ReadoutTest.</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../BugIssues_FreqAsks/" class="btn btn-neutral float-right" title="Bug Issues & Freq Asks"/>Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../Development_Process/" class="btn btn-neutral" title="Development Process"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
	  
        </div>
      </div>

    </section>

  </div>

<div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../Development_Process/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../BugIssues_FreqAsks/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>

</body>
</html>
